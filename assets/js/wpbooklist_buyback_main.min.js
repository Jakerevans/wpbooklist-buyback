console.log(wpbooklist_buyback_php_variables);

jQuery(document).ready(function($) {

	var titleResponseDiv = $('#wpbooklist-buyback-title-response');
	var smileIcon = $('#wpbooklist-smile-icon-1');
	var statusDiv = $('#wpbooklist-buyback-status-div');
	var spinner = $('#wpbooklist-spinner-buyback');
	var titleResponse = '';
	var totalAdded = 0;
	var scrollTop = 0;
	var totalAdded = 0;
	var errorFlag = false;
	var errorCounter = 0;
	var failedIsbns = '';
	var isbnIterator = 0;
	var totalIsbns = 0;

	// Reset UI elements
	titleResponseDiv.animate({'opacity':'0', 'height':'0px'}, 1000);
	statusDiv.animate({'opacity':'0', 'margin-bottom':'0px'}, 1000);

	// The 'Add Books' button
	$(document).on("click","#wpbooklist-buyback-add-checked", function(event){

		// Resetting UI elements and controlling vars
		totalIsbns = 0;
		totalAdded = 0;

		$('#wpbooklist-buyback-div-for-hiding-scroll').animate({'height':'155px'})
		$('#wpbooklist-buyback-status-div').animate({'margin-bottom':'90px'})

		$('#wpbooklist-buyback-add-checked').prop('disabled', true);

		$('.wpbooklist-buyback-checkbox-div input').each(function(){
			if($(this).prop('checked') == true){
				totalIsbns++;
			}
		});

		spinner.animate({'opacity':'1'}, 1000);
		statusDiv.animate({'opacity':'1', 'margin-bottom':'90px'}, 1000);
		statusDiv.html('<p>Adding <span class="wpbooklist-color-orange-italic">'+totalIsbns+'</span> Books...</p>');

		scrollTop = $('#wpbooklist-buyback-search-button').offset().top-50;
		if(scrollTop != 0){
		  $('html, body').animate({
		    scrollTop: scrollTop
		  }, 500);
		  scrollTop = 0;
		}

	var isbnArray = [];
		$('.wpbooklist-buyback-checkbox-div input').each(function(){
			isbnArray.push($(this).parent().parent().attr('data-isbn'));
		});

		(function wpbooklist_buyback_add_book_worker() {
  		isbnArray[isbnIterator]
			
				var library = $('#wpbooklist-buyback-select-library').val();
				var page = $('#buyback-create-page').prop('checked');
				var post = $('#buyback-create-post').prop('checked');
				var woo = $('#buyback-create-woo').prop('checked');
				

				var data = {
				'action': 'wpbooklist_buyback_addbooks_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce1,
				'isbn':isbnArray[isbnIterator],
				'library':library,
				'page':page,
				'post':post,
				'woo':woo
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {

			    	response = response.split('sep');
			    	// If the ajax call was succesful but the book wasn't found or some other error retreiving the book information occurred (probably due to a bad ISBN number)
			    	if(response[7] == '' || response[7] == 'undefined' || response[7] == undefined){
			    		failedIsbns = failedIsbns+','+response[8];
			    		errorCounter++;
			    	} else {
			    		totalAdded++;
			    		// Handle UI progress updates
				    	titleResponseDiv.scrollTop(titleResponseDiv.prop("scrollHeight"));
				    	titleResponseDiv.animate({'opacity':'1'}, 1000);
				    	smileIcon.animate({'opacity':'1'}, 1000);
				   		titleResponseDiv.css({'height':'155px'});
				    	titleResponse = titleResponse+" Added<br/><span class='wpbooklist-buyback-response-span'>'"+response[7]+"'</span><br/>";
				    	titleResponseDiv.html(titleResponse);

				    	statusDiv.html('<p>Adding <span class="wpbooklist-color-orange-italic">'+totalIsbns+'</span> Books...</p><p>Succesfully Added <span class="wpbooklist-color-orange-italic">'+totalAdded+'</span> books!<img id="wpbooklist-smile-icon-1" src="'+wpbooklist_buyback_php_variables.wpbooklistbuybackrootimgiconsurl+'smile.png" /><p>');
			    	}

			    	// handling UI stuff once all books have made an attempt to be added
			    	if(totalAdded == (totalIsbns-errorCounter)){
			    		spinner.animate({'opacity':'0'}, 1000);
			    		failedIsbns = failedIsbns.replace(/^,|,$/g,'');
			    		var failedIsbnsArray = failedIsbns.split(',');
			    		var failedIsbnsArrayUnique = [];

			    		// Making the failed ISBN unique array
						$.each(failedIsbnsArray, function(i, el){
						    if($.inArray(el, failedIsbnsArrayUnique) === -1) failedIsbnsArrayUnique.push(el);
						});

						// Creating ISBN error message
						var errorReportString = '';
						if(failedIsbnsArrayUnique.length > 0 && failedIsbnsArrayUnique[0] != ''){
							for (var i = failedIsbnsArrayUnique.length - 1; i >= 0; i--) {
								if(failedIsbnsArrayUnique[i] != 'undefined' && failedIsbnsArrayUnique[i] != undefined){
									errorReportString = errorReportString+'<p class="wpbooklist-buyback-error-isbn">'+failedIsbnsArrayUnique[i]+'</p>'
								}
							}
							titleResponseDiv.html('<p id="wpbooklist-buyback-isbn-error-message"><span class="wpbooklist-color-orange-italic">WPBookList</span> had trouble finding information for these ISBN Numbers:</p>'+errorReportString);
							titleResponseDiv.animate({ scrollTop: 0 }, "fast");
						}

			    		console.log(failedIsbnsArrayUnique);
			    		$('#wpbooklist-buyback-add-checked').prop('disabled', false);
			    	}
			    },
				error: function(jqXHR, textStatus, errorThrown) {
					console.log(errorThrown);
		            console.log(textStatus);
		            console.log(jqXHR);
		            errorCounter++;
				},
				complete: function() {
					isbnIterator++;
			      	// Schedule the next request when the current one's complete, if we're not doen already
			      	if(totalAdded != (totalIsbns-errorCounter)){
						setTimeout(wpbooklist_buyback_add_book_worker, 1000);
					}
			    }
			});
		})();


		event.preventDefault ? event.preventDefault() : event.returnValue = false;
	});




	// The 'Check All' button
	$(document).on("click","#wpbooklist-buyback-all-checked", function(event){
		$('.wpbooklist-buyback-checkbox-div input').each(function(){
			$(this).prop('checked', true);
		});

		$('#wpbooklist-buyback-add-checked').prop('disabled', false);

		event.preventDefault ? event.preventDefault() : event.returnValue = false;
	});

	// The 'Uncheck All' button
	$(document).on("click","#wpbooklist-buyback-add-uncheck", function(event){
		$('.wpbooklist-buyback-checkbox-div input').each(function(){
			$(this).prop('checked', false);
		});

		$('#wpbooklist-buyback-add-checked').prop('disabled', true);

		event.preventDefault ? event.preventDefault() : event.returnValue = false;
	});

	// Enable 'Add Book' button when any checkbox is checked
	$(document).on("click",".wpbooklist-buyback-checkbox-div input", function(event){
		if($(this).prop('checked') == true){
			$('#wpbooklist-buyback-add-checked').prop('disabled', false);
		} else {
			$('#wpbooklist-buyback-add-checked').prop('disabled', true);
			$('.wpbooklist-buyback-checkbox-div input').each(function(){
				if($(this).prop('checked') == true){
					$('#wpbooklist-buyback-add-checked').prop('disabled', false);
				}
			});
		}
	});	


	$("#wpbooklist-buyback-search-button").click(function(event){

		var author = $('#wpbooklist-buyback-author-input').val();
		var title = $('#wpbooklist-buyback-title-input').val();
		var isbn = $('#wpbooklist-buyback-isbn').val();
		var username = '';

		// Modify isbn to remove possible dashes 
		isbn = isbn.replace(/-/g, '');

		if (window.location.search.indexOf('buybackusername=') > -1) {
			var url = new URL(window.location.href);
			username = url.searchParams.get("buybackusername");
		}

		if(title == 'Search by Title'){
			title = '';
		}

		if(author == 'Search by Author'){
			author = '';
		}

		$('#wpbooklist-spinner-buyback').animate({'opacity':'1'})
		$('#wpbooklist-buyback-results-div').animate({'opacity':'0'})

		$('#wpbooklist-buyback-results-div').animate({opacity:0});

		var data = {
			'action': 'wpbooklist_buyback_search_action',
			'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce3,
			'author':author,
			'title':title,
			'isbn':isbn,
			'username':username
		};

		var request = $.ajax({
		    url: ajaxurl,
		    type: "POST",
		    data:data,
		    timeout: 0,
		    success: function(response) {
		    	wpbooklist_buyback_handle_search_results(response, 'initial');
		    }
		});
		event.preventDefault ? event.preventDefault() : event.returnValue = false;
	});

	$(document).on("click",".wpbooklist-buyback-colorbox", function(event){

		var title = $(this).parent().attr('data-title');
		var author = $(this).parent().attr('data-author');
		var category = $( "input[name='book-category']" ).val();
		var pages = $(this).parent().attr('data-pages');
		var pubYear = $(this).parent().attr('data-pubdate');
		var publisher = $(this).parent().attr('data-publisher');
		var description = $(this).parent().attr('data-description');
		var image = $(this).attr('src');
		var reviews = $(this).parent().attr('data-review');
		var isbn = $(this).parent().attr('data-isbn');
		var details = $(this).parent().attr('data-details');
		var similar = $(this).parent().attr('data-similar');

			var data = {
			'action': 'wpbooklist_buyback_colorbox_action',
			'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce4,
			'title':title,
			'author':author,
			'category':category,
			'pages':pages,
			'pubYear':pubYear,
			'publisher':publisher,
			'description':description,
			'image':image,
			'reviews':reviews,
			'isbn':isbn,
			'details':details,
			'similar':similar
		};

		$.colorbox({
	        iframe:true,
	        title: "<?php echo $trans1; ?>", 
	        width: "50%", 
	        height: "80%", 
	        html: "&nbsp;", 
	        fastIframe:false,
	        onComplete:function(){
	          $('#cboxLoadingGraphic').show();
	          $('#cboxLoadingGraphic').css({'display':'block'})
	        }
	    });

  		var request = $.ajax({
		    url: ajaxurl,
		    type: "POST",
		    data:data,
		    timeout: 0,
		    success: function(response) {

		    	console.log(response);

		    	$.colorbox({
					open: true,
					preloading: true,
					scrolling: true,
					width:'70%',
					height:'70%',
					html: response,
					onClosed:function(){
					  //Do something on close.
					},
					onComplete:function(){

						// Hide blank 'Similar Titles' images
						$('.wpbooklist-similar-image').load(function() {
							var image = new Image();
							image.src = $(this).attr("src");
							if(image.naturalHeight == '1'){
								$(this).parent().parent().css({'display':'none'})
							}
						});

						addthis.toolbox(
			              $(".addthis_sharing_toolbox").get()
			            );
			            addthis.toolbox(
			              $(".addthis_sharing_toolbox").get()
			            );
			            addthis.counter(
			              $(".addthis_counter").get()
			            );
					}
				});

		    	console.log(response);
		    }
		});


		event.preventDefault ? event.preventDefault() : event.returnValue = false;
  	});

	function wpbooklist_buyback_handle_search_results(results, phase){

		var origResponse = results;
		var results = results.split('--sep--seperator--sep--');

		console.log(results)


		// Add the returned form to the DOM
		$('#wpbooklist-buyback-checkout-div').html(results[2]);

		var pricingScheme = JSON.parse(results[1]);
    	results = JSON.parse(results[0]);

    	console.log('pricingScheme')
    	console.log(pricingScheme)
    	
    	var html = '<div id="wpbooklist-buyback-results-container"><div id="wpbooklist-buyback-add-books-div"><div id="wpbooklist-buyback-library-select"></div></div></div>';

		console.log(results);
    	if(results == undefined || results.Items == undefined || results.Items.Item == undefined){
    		$('#wpbooklist-buyback-results-div').html('<p>Whoops! We couldn\'t find any results for your Book Search! Be sure to check the Title and/or Author you provided and try again!</p>' );
	    	$('#wpbooklist-buyback-results-div').animate({'opacity':'1'});
	    	$('#wpbooklist-spinner-buyback').animate({'opacity':'0'});
    	} else {

    		var resultsLength = results.Items.Item.length;
	    	if(resultsLength == undefined){
	    		resultsLength = 1;
	    	}

	    	if(phase == 'initial'){
	    		loopControl = resultsLength-1;
	    	}

	    	if(phase == 'titlesearch'){
	    		var loopControl = 0
	    	}

	    	for (var i = loopControl; i < resultsLength; i++) {
	    		var image = '';
	    		var author = '';
	    		var category = '';
	    		var pages = '';
	    		var publisher = '';
	    		var pubdate = '';
	    		var title = '';
	    		var description = '';
	    		var isbn = '';
	    		var review = '';
	    		var similar = '';
	    		var image = '';
	    		var isbn = '';
	    		var details = '';
	    		var similarproductsstring = '';
	    		var itemRank = 0;
	    		var lowestUsedUnformatted = '';
	    		var lowestUsedFormatted = '';

	    		console.log(results)

	    		if(results.Items.Item[i] != undefined){


	    			// Get rank and pricing data
	    			if(results.Items.Item[i].OfferSummary != undefined && results.Items.Item[i].OfferSummary.LowestUsedPrice != undefined){
		    			lowestUsedUnformatted = results.Items.Item[i].OfferSummary.LowestUsedPrice.Amount;
		    			lowestUsedFormatted = results.Items.Item[i].OfferSummary.LowestUsedPrice.FormattedPrice;
		    			itemRank = results.Items.Item[i].SalesRank;
	    			}

	    			// Get other data
	    			if(results.Items.Item[i].SimilarProducts != undefined){
		    			if(results.Items.Item[i].SimilarProducts.SimilarProduct != undefined){
		    				for (var r = 0; r < results.Items.Item[i].SimilarProducts.SimilarProduct.length; r++) {
		    					similarproductsstring = similarproductsstring+';bsp;'+results.Items.Item[i].SimilarProducts.SimilarProduct[r].ASIN+'---'+results.Items.Item[i].SimilarProducts.SimilarProduct[r].Title;
		    				};
		    			}
	    			}


	    			if(results.Items.Item[i].ASIN != undefined){
	    				isbn = results.Items.Item[i].ASIN;
	    			}

	    			if(results.Items.Item[i].CustomerReviews != undefined){
	    				if(results.Items.Item[i].CustomerReviews.IFrameURL != undefined){
	    					review = results.Items.Item[i].CustomerReviews.IFrameURL;
	    				}
	    			}

	    			if(results.Items.Item[i].DetailPageURL != undefined){
	    				details = results.Items.Item[i].DetailPageURL;
	    			}

	    			if(results.Items.Item[i].ItemAttributes != undefined){

		    			if(results.Items.Item[i].ItemAttributes.Author != undefined){
		    				author = results.Items.Item[i].ItemAttributes.Author;
		    			}

		    			if(results.Items.Item[i].ItemAttributes.EAN != undefined){
		    				isbn = results.Items.Item[i].ItemAttributes.EAN;
		    			}

		    			if(results.Items.Item[i].ItemAttributes.NumberOfPages != undefined){
		    				pages = results.Items.Item[i].ItemAttributes.NumberOfPages;
		    			}

		    			if(results.Items.Item[i].ItemAttributes.Publisher != undefined){
		    				publisher = results.Items.Item[i].ItemAttributes.Publisher;
		    			}

		    			if(results.Items.Item[i].ItemAttributes.PublicationDate != undefined){
		    				pubdate = results.Items.Item[i].ItemAttributes.PublicationDate;
		    			}

		    			if(results.Items.Item[i].ItemAttributes.Title != undefined){
		    				title = results.Items.Item[i].ItemAttributes.Title;
		    			}
	    			}

	    			if(results.Items.Item[i].LargeImage != undefined && results.Items.Item[i].LargeImage.URL != undefined){
	    				image = results.Items.Item[i].LargeImage.URL;
	    			} else {
	    				image = '';
	    			}

	    			if(results.Items.Item[i].EditorialReviews != undefined && results.Items.Item[i].EditorialReviews.EditorialReview != undefined && results.Items.Item[i].EditorialReviews.EditorialReview.Content){
	    				description = results.Items.Item[i].EditorialReviews.EditorialReview.Content;
	    				description = description.replace(/"/g,'\'');
	    				description = description.replace(/“/g,'\'');
	    			}

	    			if(description == ''){
	    				if(results.Items.Item[i].EditorialReviews != undefined && results.Items.Item[i].EditorialReviews.EditorialReview[0] != undefined){
		    				description = results.Items.Item[i].EditorialReviews.EditorialReview[0].Content;
		    				description = description.replace(/"/g,'\'');
		    				description = description.replace(/“/g,'\'');
	    				}
	    			}
	    		} else {

	    			// Get rank and pricing data
	    			if(results.Items.Item.OfferSummary != undefined && results.Items.Item.OfferSummary.LowestUsedPrice != undefined){
		    			lowestUsedUnformatted = results.Items.Item.OfferSummary.LowestUsedPrice.Amount;
		    			lowestUsedFormatted = results.Items.Item.OfferSummary.LowestUsedPrice.FormattedPrice;
		    			itemRank = results.Items.Item.SalesRank;
	    			}

	    			if(results.Items.Item.SimilarProducts != undefined){
		    			if(results.Items.Item.SimilarProducts.SimilarProduct != undefined){
		    				for (var r = 0; r < results.Items.Item.SimilarProducts.SimilarProduct.length; r++) {
		    					similarproductsstring = similarproductsstring+';bsp;'+results.Items.Item.SimilarProducts.SimilarProduct[r].ASIN+'---'+results.Items.Item.SimilarProducts.SimilarProduct[r].Title;
		    				};
		    			}
	    			}

	    			//console.log(similarproductsstring);

	    			if(results.Items.Item.ASIN != undefined){
	    				isbn = results.Items.Item.ASIN;
	    			}

	    			if(results.Items.Item.CustomerReviews != undefined){
	    				if(results.Items.Item.CustomerReviews.IFrameURL != undefined){
	    					review = results.Items.Item.CustomerReviews.IFrameURL;
	    				}
	    			}

	    			if(results.Items.Item.DetailPageURL != undefined){
	    				details = results.Items.Item.DetailPageURL;
	    			}

	    			if(results.Items.Item.ItemAttributes != undefined){

		    			if(results.Items.Item.ItemAttributes.Author != undefined){
		    				author = results.Items.Item.ItemAttributes.Author;
		    			}

		    			if(results.Items.Item.ItemAttributes.EAN != undefined){
		    				isbn = results.Items.Item.ItemAttributes.EAN;
		    			}

		    			if(results.Items.Item.ItemAttributes.NumberOfPages != undefined){
		    				pages = results.Items.Item.ItemAttributes.NumberOfPages;
		    			}

		    			if(results.Items.Item.ItemAttributes.Publisher != undefined){
		    				publisher = results.Items.Item.ItemAttributes.Publisher;
		    			}

		    			if(results.Items.Item.ItemAttributes.PublicationDate != undefined){
		    				pubdate = results.Items.Item.ItemAttributes.PublicationDate;
		    			}

		    			if(results.Items.Item.ItemAttributes.Title != undefined){
		    				title = results.Items.Item.ItemAttributes.Title;
		    			}
	    			}

	    			if(results.Items.Item.LargeImage != undefined && results.Items.Item.LargeImage.URL != undefined){
	    				image = results.Items.Item.LargeImage.URL;
	    			} else {
	    				image = '';
	    			}

	    			if(results.Items.Item.EditorialReviews != undefined && results.Items.Item.EditorialReviews.EditorialReview != undefined && results.Items.Item.EditorialReviews.EditorialReview.Content){
	    				description = results.Items.Item.EditorialReviews.EditorialReview.Content;
	    				description = description.replace(/"/g,'\'');
	    				description = description.replace(/“/g,'\'');
	    			}

	    			if(description == ''){
	    				if(results.Items.Item.EditorialReviews != undefined && results.Items.Item.EditorialReviews.EditorialReview[0] != undefined){
		    				description = results.Items.Item.EditorialReviews.EditorialReview[0].Content;
		    				description = description.replace(/"/g,'\'');
		    				description = description.replace(/“/g,'\'');
	    				}
	    			}
	    		}

	    		// Now build offer price with the saved pricing scheme data
	    		//0-20000-30-8;20001-30000-20-6
				console.log('pricingScheme[0]')
				console.log(pricingScheme[0])
	    		var tempPricingScheme = pricingScheme[0].rankcalcs.split(';');
	    		var loopControl2 = tempPricingScheme.length;
	    		var finalPrice = 0.00;
	    		var finalPriceWithoutSym = 0.00;
	    		var threshold = 0.00;

	    		
	    		for (var r = 0; r < loopControl2; r++) {

	    			if(finalPrice == 0.00){

		    			tempPricingScheme2 = tempPricingScheme[r].split('-');

		    			if(itemRank >= parseInt(tempPricingScheme2[0]) && itemRank <= parseInt(tempPricingScheme2[1])){
		    				
		    				var monetarySymbol = lowestUsedFormatted.substring(0,1);
		    				var amountForCalc = lowestUsedFormatted.substring(1);

		    				finalPrice = (amountForCalc*(tempPricingScheme2[2]*0.01)).toFixed(2);
		    				finalPriceWithoutSym = finalPrice;
		    				finalPrice = monetarySymbol+finalPrice;
		    				threshold = tempPricingScheme2[3];
		    			}
	    			}
	    		};

	    		console.log('finalPrice')
    			console.log(finalPrice)
    			console.log('threshold')
    			console.log(threshold)

	    		var disabledButton="";
	    		var buttonOpacity = 1;
	    		var inlinePriceStyle = '';
	    		if(finalPrice == 0 || finalPrice == 0.00 || finalPriceWithoutSym < threshold){
	    			finalPrice = "Sorry, we're unable to purchase this title!";
	    			inlinePriceStyle = 'bottom:0; font-size:18px;';
	    			disabledButton = 'disabled';
	    			buttonOpacity = 0;
	    		}
	    		


	    		if(image == null || image == undefined || image == ''){
	    			image = wpbooklist_buyback_php_variables.wpbooklistbuybackrootimgiconsurl
+'image_unavaliable.png';
	    		}


	    		html = html+'<div class="wpbooklist-buyback-indiv-holder"><div data-priceformatted="'+lowestUsedFormatted+'" data-unformatted="'+lowestUsedUnformatted+'" data-rank="'+itemRank+'" data-similar="'+similarproductsstring+'" data-details="'+details+'" data-isbn="'+isbn+'" data-title="'+title+'" data-author="'+author+'" data-category="'+category+'" data-pages="'+pages+'" data-publisher="'+publisher+'" data-pubdate="'+pubdate+'" data-description="'+description+'" data-isbn="'+isbn+'" data-review="'+review+'" data-similar="'+similar+'"   class="wpbooklist-buyback-results-indiv"><img class="wpbooklist-buyback-colorbox" src="'+image+'" /><div id="wpbooklist_saved_title_and_select_div"><p class="wpbooklist_saved_title_link" id="wpbooklist_saved_title_link">'+title+'</p><div style="'+inlinePriceStyle+'" class="wpbooklist-buyback-quote-div"><span class="wpbooklist-buyback-quote-label">Quote:</span><span class="wpbooklist-buyback-quote-actual">'+finalPrice+'</span></div><div class="wpbooklist-buyback-checkbox-div"><button style="opacity:'+buttonOpacity+';" '+disabledButton+' id="wpbooklist-buyback-select-title-button-id-'+i+'" data-triggered="false" data-bookimgsrc="'+image+'" data-bookisbn="'+isbn+'" data-bookvalue="'+finalPriceWithoutSym+'" data-booktitle="'+title+'" data-buttonid="'+i+'" class="wpbooklist-buyback-select-title-button">Sell This Book</button></div></div></div></div>';
	    	};
			
			if(phase == 'initial'){
	    		html = html+'<div id="wpbooklist-buyback-notbook-div"><p>Not the Right Book? Search by title here:</p><input placeholder="Search by Title" id="wpbooklist-buyback-title-input" type="text"/><button id="wpbooklist-buyback-search-title-button">Search by Title</button></div></div>';
	    	 } else {
	    	 	html = html+'';
	    	 }

	    	$('#wpbooklist-buyback-results-div').html(html);
	    	$('#wpbooklist-buyback-library-select').html(results[1]);
	    	$('#wpbooklist-buyback-results-div').animate({'opacity':'1'})
	    	$('#wpbooklist-spinner-buyback').animate({'opacity':'0'})
	    	//console.log(html);

    	}		    	
    }

	$(document).on("click","#wpbooklist-buyback-search-title-button", function(event){

		var title = $('#wpbooklist-buyback-title-input').val();


		if(title == 'Search by Title'){
			title = '';
		}

		$('#wpbooklist-spinner-buyback').animate({'opacity':'1'})
		$('#wpbooklist-buyback-results-div').animate({'opacity':'0'})

		$('#wpbooklist-buyback-results-div').animate({opacity:0});

   		var data = {
			'action': 'wpbooklist_buyback_search_action',
			'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce3,
			'title':title,
		};

		var request = $.ajax({
		    url: ajaxurl,
		    type: "POST",
		    data:data,
		    timeout: 0,
		    success: function(response) {
		    	wpbooklist_buyback_handle_search_results(response, 'titlesearch');
		    }
		});

		event.preventDefault ? event.preventDefault() : event.returnValue = false;
	});

	$(document).on("click",".wpbooklist-buyback-select-title-button", function(event){

		$("#wpbooklist-buyback-checkout-div").animate({
	        opacity:1
	    }, 1000);

	    scrollTop = $('#wpbooklist-buyback-checkout-div').offset().top-50;
		if(scrollTop != 0){
		  $('html, body').animate({
		    scrollTop: scrollTop
		  }, 1000);
		  scrollTop = 0;
		}

	    var id = $(this).attr('data-buttonid');
	    var imgsrc = $(this).attr('data-bookimgsrc');
	    var bookisbn = $(this).attr('data-bookisbn');
	    var booktitle = $(this).attr('data-booktitle');
	    var bookvalue = $(this).attr('data-bookvalue');

	    $('#wpbooklist-buyback-login-button').attr('data-selectedbook', id);
	    $('#wpbooklist-buyback-register-button').attr('data-selectedbook', id);

	    // Build the string to add to and/or remove from the DB
	    //9780553448146;;;Artemis: A Novel;;;https://images-na.ssl-images-amazon.com/images/I/41mpiaisIIL.jpg;;;2.25----9780307887443;;;Ready Player One: A Novel;;;https://images-na.ssl-images-amazon.com/images/I/51NzrYog-7L.jpg;;;0.99
	    var dbString = bookisbn+';;;'+booktitle+';;;'+imgsrc+';;;'+bookvalue;

	    // Add a row in the Cart div
	    var newrow = '<div class="wpbooklist-buyback-cart-div-row"><div class="wpbooklist-buyback-cart-img-div"><img class="wpbooklist-buyback-cart-img-actual" src="'+imgsrc+'"/></div><div style="margin-left:4px;" class="wpbooklist-buyback-cart-title-div"><p class="wpbooklist-buyback-cart-title-actual">'+booktitle+'</p><p class="wpbooklist-buyback-cart-title-isbn-actual">'+bookisbn+'</p></div><div style="margin-left:3px;" class="wpbooklist-buyback-cart-value-div"><p class="wpbooklist-buyback-cart-value-actual">$'+bookvalue+'</p><div class="wpbooklist-buyback-cart-value-remove-div" data-dbstring="'+dbString+'"><img class="wpbooklist-buyback-cart-value-remove-img-actual" src="'+wpbooklist_buyback_php_variables.wpbooklistbuybackrootimgiconsurl+'cancel-button.svg" /><p style="margin-left:3px;" class="wpbooklist-buyback-cart-value-remove-text-actual">Remove from Cart</p></div></div></div>';
		$(newrow).insertBefore($('.wpbooklist-buyback-cart-summary-row'));

		// Update cart total values
		$('#wpbooklist-buyback-cart-summary-span-value-calc').text((parseFloat($('#wpbooklist-buyback-cart-summary-span-value-calc').text())+parseFloat(bookvalue)).toFixed(2))
		$('#wpbooklist-buyback-cart-summary-span-total-calc').text(parseInt($('#wpbooklist-buyback-cart-summary-span-total-calc').text())+1);

		// Now make Ajax call to server to add new book to the Cart field in DB
		var data = {
			'action': 'wpbooklist_buyback_add_to_cart_action',
			'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce8,
			'title':booktitle,
			'isbn':bookisbn,
			'image':imgsrc,
			'value':bookvalue,

		};

		var request = $.ajax({
		    url: ajaxurl,
		    type: "POST",
		    data:data,
		    timeout: 0,
		    success: function(response) {
		    	console.log(response);
		    }
		});

		event.preventDefault ? event.preventDefault() : event.returnValue = false;
	});




	$(document).on("click","#wpbooklist-buyback-login-button", function(event){


		$('#wpbooklist-buyback-login-reg-button-error-p').text('')
		var email = $('#wpbooklist-buyback-login-reg-contact-field-username').val();
		var password = $('#wpbooklist-buyback-login-reg-contact-field-password').val();
		var isbn = $('#wpbooklist-buyback-isbn').val();
		var search = $('#wpbooklist-buyback-title-input').val();
		var book = $(this).attr('data-selectedbook');
		var proceed = false;

		// Checks for no input
		if(email == ''){
			$('#wpbooklist-buyback-login-reg-button-error-p').text('Enter a Username/E-Mail Address!');
			return;
		}

		// Checks for no input
		if(password == ''){
			$('#wpbooklist-buyback-login-reg-button-error-p').text('Enter a Password!')
			return;
		}

		proceed = true;

		if(proceed){

			$('#wpbooklist-spinner-buyback-login').animate({'opacity':'1'})

			var data = {
				'action': 'wpbooklist_buyback_login_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce5,
				'email':email,
				'password':password
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {


			    	if(response == '--Username Found----Password Matches--'){
			    		var newUrl = window.location.href+'?buybackusername='+email+'&isbn='+isbn+'&book='+book;

			    		window.location.href = newUrl;
			    	}

			    	if(response == '--Username Found----Password Does Not Match--'){
			    		$('#wpbooklist-buyback-login-reg-button-error-p').text('Whoops! Looks like you entered the wrong password!');
			    		$('#wpbooklist-spinner-buyback-login').animate({'opacity':'0'})
			    	}

			    	if(response == 'Username not found!--'+email+'--'+password){
			    		$('#wpbooklist-buyback-login-reg-button-error-p').text('Whoops! Looks like we can\'t find that Username!');
			    		$('#wpbooklist-spinner-buyback-login').animate({'opacity':'0'})
			    	}


			    	console.log(response)
			    }
			});
		}

		event.preventDefault ? event.preventDefault() : event.returnValue = false;
	});





	jQuery(window).load(function () {

		var isbnbox = $('#wpbooklist-buyback-isbn');
		var isbnsubmit = $('#wpbooklist-buyback-search-button');

		if ((window.location.search.indexOf('buybackusername=') > -1) && isbnbox.length > 0) {

			var url = new URL(window.location.href);
			var email = url.searchParams.get("buybackusername");

			var data = {
				'action': 'wpbooklist_buyback_populate_userdata_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce6,
				'email':email
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {
			    	response = JSON.parse(response);
			    	console.log(response[0].firstname);


			    	var checkExistFields = setInterval(function() {
					   if ('#wpbooklist-buyback-checkout-contact-field-firstname'.length) {
					      	$('#wpbooklist-buyback-checkout-contact-field-firstname').val(response[0].firstname);
			    			$('#wpbooklist-buyback-checkout-contact-field-lastname').val(response[0].lastname);
			    			$('#wpbooklist-buyback-checkout-contact-field-streetaddress').val(response[0].streetaddress);
			    			$('#wpbooklist-buyback-checkout-contact-field-city').val(response[0].city);
			    			//$('#wpbooklist-buyback-checkout-contact-field-state').val(response[0].state);
			    			$('#wpbooklist-buyback-checkout-contact-field-zip').val(response[0].zipcode);
					      	
					      	if($('#wpbooklist-buyback-checkout-contact-field-firstname').val() == response[0].firstname){
					      		clearInterval(checkExistFields);
					      	}
					   }
					}, 100); // check every 100ms


			    	
			    	console.log(response);
			    }
			});


			var url = new URL(window.location.href);
			var username = url.searchParams.get("buybackusername");
			var isbn = url.searchParams.get("isbn");
			var searchterm = url.searchParams.get("search");
			var book = url.searchParams.get("book");

			isbnbox.val(isbn);
			isbnsubmit.trigger('click');
			$('#wpbooklist-buyback-select-title-button-id-'+book).trigger('click');

			var checkExist = setInterval(function() {
			   if ('#wpbooklist-buyback-select-title-button-id-'+book.length) {


			   		if($('#wpbooklist-buyback-select-title-button-id-'+book).attr('data-triggered') == 'false'){
			      		$('#wpbooklist-buyback-select-title-button-id-'+book).trigger('click');
			      		$('#wpbooklist-buyback-select-title-button-id-'+book).attr('data-triggered', 'true');
			      	}
			      	
			      	if($('#wpbooklist-buyback-checkout-div').css('opacity') == 1){
			      		clearInterval(checkExist);
			      	}
			   }
			}, 100); // check every 100ms
		}

	});



	$(document).on("click","#wpbooklist-buyback-register-button", function(event){

		$('#wpbooklist-buyback-register-button-error-p').text('')
		var email = $('#wpbooklist-buyback-login-reg-contact-field-email').val();
		var password = $('#wpbooklist-buyback-login-reg-contact-field-register-password').val();
		var password2 = $('#wpbooklist-buyback-login-reg-contact-field-register-reenterpassword').val();
		var firstname = $('#wpbooklist-buyback-login-reg-contact-field-firstname').val();
		var lastname = $('#wpbooklist-buyback-login-reg-contact-field-lastname').val();
		var streetaddress = $('#wpbooklist-buyback-login-reg-contact-field-streetaddress').val();
		var city = $('#wpbooklist-buyback-login-reg-contact-field-city').val();
		var state = $('#wpbooklist-buyback-login-reg-contact-field-state').val();
		var zip = $('#wpbooklist-buyback-login-reg-contact-field-zip').val();


		var isbn = $('#wpbooklist-buyback-isbn').val();
		var search = $('#wpbooklist-buyback-title-input').val();
		var book = $(this).attr('data-selectedbook');
		var proceed = false;

		// Checks for no input
		if(firstname == ''){
			$('#wpbooklist-buyback-register-button-error-p').text('Enter your First Name!')
			return;
		}

		// Checks for no input
		if(lastname == ''){
			$('#wpbooklist-buyback-register-button-error-p').text('Enter your Last Name!')
			return;
		}

		// Checks for no input
		if(streetaddress == ''){
			$('#wpbooklist-buyback-register-button-error-p').text('Enter your Street Address!')
			return;
		}

		// Checks for no input
		if(city == ''){
			$('#wpbooklist-buyback-register-button-error-p').text('Enter a City!')
			return;
		}

		// Checks for no input
		if(state == 'Select a State...'){
			$('#wpbooklist-buyback-register-button-error-p').text('Select a State!')
			return;
		}

		// Checks for no input
		if(zip == ''){
			$('#wpbooklist-buyback-register-button-error-p').text('Enter a Zip Code!')
			return;
		}

		// Checks for no input
		if(password == ''){
			$('#wpbooklist-buyback-register-button-error-p').text('Enter a Password!')
			return;
		}

		// Checks for no input
		if(password2 == ''){
			$('#wpbooklist-buyback-register-button-error-p').text('Re-Enter your Password!')
			return;
		}

		if(password !== password2){
			$('#wpbooklist-buyback-register-button-error-p').text('Your passwords don\'t match!')
			return;
		}

		if(email == ''){
			$('#wpbooklist-buyback-register-button-error-p').text('Enter an E-Mail Address!');
			return;
		}

		proceed = true;

		if(proceed){

			$('#wpbooklist-spinner-buyback-register').animate({'opacity':'1'})

			var data = {
				'action': 'wpbooklist_buyback_register_userdata_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce7,
				'username':email,
				'password':password,
				'email':email,
				'state':state,
				'city':city,
				'streetaddress':streetaddress,
				'firstname':firstname,
				'lastname':lastname,
				'zip':zip
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {

			    	$('#wpbooklist-spinner-buyback-register').animate({'opacity':'0'})

			    	if(response == 'Success!'){
			    		$('#wpbooklist-buyback-register-button-error-p').text('Success!');

			    		var newUrl = window.location.href+'?buybackusername='+email+'&isbn='+isbn+'&book='+book;

			    		window.location.href = newUrl;

			    	} else {
			    		$('#wpbooklist-buyback-register-button-error-p').text(response);
			    	}
			    	

			    	console.log(response)
			    }
			});
		}


		event.preventDefault ? event.preventDefault() : event.returnValue = false;
	});


	$(document).on("click",".wpbooklist-buyback-cart-value-remove-div", function(event){
		$(this).parent().parent().remove()

		// Adjust cart totals/values
		var currentNum = $('#wpbooklist-buyback-cart-summary-span-total-calc').text();
		$('#wpbooklist-buyback-cart-summary-span-total-calc').text(parseInt(currentNum)-1)

		var currentVal = $('#wpbooklist-buyback-cart-summary-span-value-calc').text();
		var bookVal = $(this).prev().text()
		bookVal = bookVal.replace('$','');
		$('#wpbooklist-buyback-cart-summary-span-value-calc').text((parseFloat($('#wpbooklist-buyback-cart-summary-span-value-calc').text())-parseFloat(bookVal)).toFixed(2))


		// Now remove from db
		var dbString = $(this).attr('data-dbstring');
		var data = {
			'action': 'wpbooklist_buyback_add_to_cart_remove_action',
			'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce9,
			'dbString':dbString
		};

		var request = $.ajax({
		    url: ajaxurl,
		    type: "POST",
		    data:data,
		    timeout: 0,
		    success: function(response) {

		    	
		    	console.log(response)
		    }
		});

	});

	$(document).on("change","#wpbooklist-buyback-checkout-contact-field-payment", function(event){
		if($(this).val() == 'PayPal'){
			$('.wpbooklist-buyback-checkout-row-paypal-email').animate({'height':'119px', 'opacity':'1'})
		}
	});

	$(document).on("click","#wpbooklist-buyback-finalize-sale-button", function(event){

		

		// Get all values again to make sure no contact info changed
		$('#wpbooklist-buyback-finalize-sale-button-error-p').text('')
		var email = $('#wpbooklist-buyback-checkout-contact-field-email').val();
		var firstname = $('#wpbooklist-buyback-checkout-contact-field-firstname').val();
		var lastname = $('#wpbooklist-buyback-checkout-contact-field-lastname').val();
		var streetaddress = $('#wpbooklist-buyback-checkout-contact-field-streetaddress').val();
		var city = $('#wpbooklist-buyback-checkout-contact-field-city').val();
		var state = $('#wpbooklist-buyback-checkout-contact-field-state').val();
		var zip = $('#wpbooklist-buyback-checkout-contact-field-zipcode').val();
		var phone = $('#wpbooklist-buyback-checkout-contact-field-phone').val();
		var paymentMethod = $('#wpbooklist-buyback-checkout-contact-field-payment').val();
		var paypal1 = '';
		var paypal2 = '';
		var books = '';

		// Build Books string from cart
		var books = '';
		$('.wpbooklist-buyback-cart-div-row').each(function(){
			//9780553448146;;;Artemis: A Novel;;;https://images-na.ssl-images-amazon.com/images/I/41mpiaisIIL.jpg;;;2.49----9781492650959;;;The Radium Girls: The Dark Story of America\&#39;s Shining Women;;;https://images-na.ssl-images-amazon.com/images/I/51t86%2BXZO3L.jpg;;;3.36----9781492650959;;;The Radium Girls: The Dark Story of America\&#39;s Shining Women;;;https://images-na.ssl-images-amazon.com/images/I/51t86%2BXZO3L.jpg;;;3.36

			var imgsrc = $(this).find('.wpbooklist-buyback-cart-img-actual').attr('src');
			var title = $(this).find('.wpbooklist-buyback-cart-title-actual').text();
			var isbn = $(this).find('.wpbooklist-buyback-cart-title-isbn-actual').text();
			var value = $(this).find('.wpbooklist-buyback-cart-value-actual').text().replace('$','');

			books = books+isbn+';;;'+title+';;;'+imgsrc+';;;'+value+'----';
		});

		console.log(books);

		// Checks for no input
		if(firstname == ''){
			$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter your First Name!')
			return;
		}

		// Checks for no input
		if(lastname == ''){
			$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter your Last Name!')
			return;
		}

		if(email == ''){
			$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter an E-Mail Address!');
			return;
		}

		// Checks for no input
		if(streetaddress == ''){
			$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter your Street Address!')
			return;
		}

		// Checks for no input
		if(city == ''){
			$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter a City!')
			return;
		}

		// Checks for no input
		if(state == 'Select a State...' || state == null){
			$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Select a State!')
			return;
		}

		// Checks for no input
		if(zip == ''){
			$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter a Zip Code!')
			return;
		}

		// Checks for no input
		if(phone == ''){
			$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter a Phone Number!')
			return;
		}

		// Checks for no input
		if(paymentMethod == 'Select a Payment Method...'  || paymentMethod == null){
			$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Choose a Payment Method!')
			return;
		}


		if($('#wpbooklist-buyback-checkout-contact-field-payment').val() == 'PayPal'){
			paypal1 = $('#wpbooklist-buyback-checkout-contact-field-paypalemail-1').val();
			paypal2 = $('#wpbooklist-buyback-checkout-contact-field-paypalemail-2').val();

			if(paypal1 == ''){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter a PayPal E-Mail Address!');
				return;
			}

			if(paypal2 == ''){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Verify your PayPal E-Mail Address!');
				return;
			}

			if(paypal1 !== paypal2){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Looks like your PayPal E-Mail Addresses don\'t match!');
				return;
			}
		}

		$('#wpbooklist-spinner-buyback-finalize-sale').animate({'opacity':'1'})

		var data = {
			'action': 'wpbooklist_buyback_finalize_sale_action',
			'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce10,
			'firstname':firstname,
			'lastname':lastname,
			'books':books,
			'streetaddress':streetaddress,
			'phone':phone,
			'email':email,
			'paypalemail':paypal2,
			'paymentmethod':paymentMethod,
			'city':city,
			'state':state,
			'zip':zip
		};

		var request = $.ajax({
		    url: ajaxurl,
		    type: "POST",
		    data:data,
		    timeout: 0,
		    success: function(response) {

		    	
		    	console.log(response)

		    	if(response == 'Success!'){

		    		response = "<p>You've successfully placed your order! You should recieve an E-Mail with further instructions shortly.</p><p>Thanks for choosing The Bookkeeper's Den!</p>"
		    	}
		    	$('#wpbooklist-spinner-buyback-finalize-sale').animate({'opacity':'0'})

		    	$('#wpbooklist-buyback-finalize-sale-button-error').html(response);
		    }
		});

	});


	$(document).on("change",".wpbooklist-buyback-settings-input", function(event){

		var thisId = $(this).attr('id');
		var splitId = thisId.split('-');
		var thisIdNum = parseInt(splitId[5]);
		var totalInputs = $('.wpbooklist-buyback-settings-input').length;
		var thisVal = parseInt($(this).val());

		var iNum = 0;
		$('.wpbooklist-buyback-settings-input').each(function(index){
			if($(this).attr('id') == thisId){
				iNum = index;
			}
		})

		for (var i = iNum; i < (totalInputs-1); i++) {

			var curValId = $('.wpbooklist-buyback-settings-input')[i].id
			var nextNewVal = parseInt($('#'+curValId).val())+1;

			var nextId = $('.wpbooklist-buyback-settings-input')[i+1].id
			var nextCurrentVal = parseInt($('#'+nextId).val());

			if(nextCurrentVal <= thisVal){
				$('#'+nextId).val(nextNewVal);
			}
		}
	});


	$(document).on("change",".wpbooklist-buyback-settings-input", function(event){

		var thisId = $(this).attr('id');
		var splitId = thisId.split('-');
		var thisIdNum = parseInt(splitId[5]);
		var totalInputs = $('.wpbooklist-buyback-settings-input').length;
		var thisVal = parseInt($(this).val());

		var iNum = 0;
		$('.wpbooklist-buyback-settings-input').each(function(index){
			if($(this).attr('id') == thisId){
				iNum = index;
			}
		})

		for (var i = iNum; i > 0; i--) {

			console.log('loop')

			var curValId = $('.wpbooklist-buyback-settings-input')[i].id
			var nextNewVal = parseInt($('#'+curValId).val())-1;

			console.log('nextNewVal')
			console.log(nextNewVal)

			var nextId = $('.wpbooklist-buyback-settings-input')[i-1].id
			var nextCurrentVal = parseInt($('#'+nextId).val());

			if(nextCurrentVal >= thisVal){
				$('#'+nextId).val(nextNewVal);
			}
		}
	});

	$(document).on("click","#wpbooklist-buyback-settings-add-row-div", function(event){

		var nextNum = $('.wpbooklist-buyback-settings-input').length

		var secondLastId = $('.wpbooklist-buyback-settings-input')[nextNum-1].id;
		var nextFrom = parseInt($('#'+secondLastId).val())+1;
		var nextTo = nextFrom+1;

		var nextPercNum = $('.wpbooklist-buyback-settings-input-perc').length
		var LastPercId = $('.wpbooklist-buyback-settings-input-perc')[nextPercNum-1].id;
		var nextPerc = parseInt($('#'+LastPercId).val())-1;

		if(nextPerc <= 0){
			nextPerc = 1;
		}

		$('<div class="wpbooklist-buyback-settings-row-actual"><div class="wpbooklist-buyback-settings-row-actual-inner-row"><div class="wpbooklist-buyback-settings-row-actual-inner-row-top"><p class="wpbooklist-buyback-settings-row-actual-inner-row-top-p1">Amazon Sales Ranking</p><p class="wpbooklist-buyback-settings-row-actual-inner-row-top-p2">Percentage of Amazon Book Price to offer</p></div><div class="wpbooklist-buyback-settings-row-actual-inner-row-bottom"><p class="wpbooklist-buyback-settings-row-actual-inner-row-bottom-1">From: <input class="wpbooklist-buyback-settings-input" id=wpbooklist-buyback-settings-input-from-'+nextNum+' type="number" value="'+nextFrom+'" />To: <input class="wpbooklist-buyback-settings-input" id=wpbooklist-buyback-settings-input-to-'+nextNum+' type="number" value="'+nextTo+'" /></p><p style="position:relative; left:3px;" class="wpbooklist-buyback-settings-row-actual-inner-row-bottom-2">Percentage:<input style="margin-left:4px;"class="wpbooklist-buyback-settings-input-perc" id=wpbooklist-buyback-settings-input-perc-'+nextNum+' type="number" value="'+nextPerc+'" />%</p><p style="position:relative; left:8px;" class="wpbooklist-buyback-settings-row-actual-inner-row-bottom-3">Threshold:<input style="margin-left:4px;" class="wpbooklist-buyback-settings-input-perc" id=wpbooklist-buyback-settings-input-threshold-'+nextNum+' type="number" step="0.01" value="8.00" /></p></div></div></div>').insertBefore($(this).parent())

		$("#wpbooklist-buyback-settings-delete-row-div").removeAttr('disabled')
	});

	$(document).on("click","#wpbooklist-buyback-settings-delete-row-div", function(event){
		var idNumToRemove = $('.wpbooklist-buyback-settings-row-actual').length
		if(idNumToRemove > 1){
			var idToRemove = $('.wpbooklist-buyback-settings-row-actual')[idNumToRemove-1].remove()
		} else {
			$(this).attr('disabled','true')
		}
	});

	$(document).on("click","#wpbooklist-buyback-settings-save-div button", function(event){

		var settingstring = '';
		$('#wpbooklist-spinner-buyback').animate({'opacity':'1'})
		$('.wpbooklist-buyback-settings-row-actual').each(function(){

			$(this).find('input').each(function(){
				settingstring += $(this).val()+'-';
			})
			settingstring += '0;';
		})

		settingstring = settingstring.substring(0, settingstring.length - 1);

		var data = {
			'action': 'wpbooklist_buyback_save_settings_action',
			'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce11,
			'settingstring':settingstring,
		};

		var request = $.ajax({
		    url: ajaxurl,
		    type: "POST",
		    data:data,
		    timeout: 0,
		    success: function(response) {

		    	document.location.reload(true);
		    	console.log(response)

		    }
		});

		console.log(settingstring);


	});


	$(document).on("click",".wpbooklist-buyback-settings-save-changes-row-div", function(event){
		var orderId = $(this).attr('data-orderid');
		var orderStatus = $('#wpbooklist-buyback-select-id-'+orderId).val();
		$('#wpbooklist-spinner-buyback').animate({'opacity':'1'})

		var data = {
			'action': 'wpbooklist_buyback_save_order_changes_action',
			'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce12,
			'orderStatus':orderStatus,
			'orderId':orderId,
		};

		console.log(data);

		var request = $.ajax({
		    url: ajaxurl,
		    type: "POST",
		    data:data,
		    timeout: 0,
		    success: function(response) {
		    	document.location.reload(true);
		    	console.log(response)

		    }
		});
	});


	$(document).on("click",".wpbooklist-buyback-settings-delete-order-row-div", function(event){
		var orderId = $(this).attr('data-orderid');
		$('#wpbooklist-spinner-buyback').animate({'opacity':'1'})

		var data = {
			'action': 'wpbooklist_buyback_delete_order_changes_action',
			'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce13,
			'orderId':orderId,
		};

		console.log(data);

		var request = $.ajax({
		    url: ajaxurl,
		    type: "POST",
		    data:data,
		    timeout: 0,
		    success: function(response) {
		    	document.location.reload(true);
		    	console.log(response)

		    }
		});
	});

	




});