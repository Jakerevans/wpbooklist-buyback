/**
 * JavaScript Admin Functions - wpbooklist-buyback-admin.min.js
 *
 * @author   Jake Evans
 * @category JavaScript
 * @package  Includes/Assets/Js
 * @version  2.0.0
 */

console.log('This is the JavaScript Object that holds all PHP Variables for use in JavaScript')
console.log(wpbooklist_buyback_php_variables)


// All functions wrapped in jQuery(document).ready()...
jQuery(document).ready(function($) {
	"use strict";

	/* BEGINNING SECTION TO CALL ALL FUNCTIONS IN FILE... */
	wpbooklist_buyback_jre_auto_adjust_sales_inputs_1();

	wpbooklist_buyback_jre_auto_adjust_sales_inputs_2();

	wpbooklist_buyback_jre_add_sales_row();

	wpbooklist_buyback_jre_delete_sales_row();

	wpbooklist_buyback_jre_save_sales_data();

	wpbooklist_buyback_jre_save_order_changes();

	wpbooklist_buyback_jre_delete_existing_order();


	/* ENDING SECTION TO CALL ALL FUNCTIONS IN FILE... */

	// A function that auto-adjusts the numerical values in the Sales Ranking fields
	function wpbooklist_buyback_jre_auto_adjust_sales_inputs_1(){

		$(document).on("change",".wpbooklist-buyback-settings-input", function(event){

			var thisId = $(this).attr('id');
			var splitId = thisId.split('-');
			var thisIdNum = parseInt(splitId[5]);
			var totalInputs = $('.wpbooklist-buyback-settings-input').length;
			var thisVal = parseInt($(this).val());

			var iNum = 0;
			$('.wpbooklist-buyback-settings-input').each(function(index){
				if($(this).attr('id') == thisId){
					iNum = index;
				}
			})

			for (var i = iNum; i < (totalInputs-1); i++) {

				var curValId = $('.wpbooklist-buyback-settings-input')[i].id
				var nextNewVal = parseInt($('#'+curValId).val())+1;

				var nextId = $('.wpbooklist-buyback-settings-input')[i+1].id
				var nextCurrentVal = parseInt($('#'+nextId).val());

				if(nextCurrentVal <= thisVal){
					$('#'+nextId).val(nextNewVal);
				}
			}
		});

	}

	// A function that auto-adjusts the numerical values in the Sales Ranking fields
	function wpbooklist_buyback_jre_auto_adjust_sales_inputs_2(){

		$(document).on("change",".wpbooklist-buyback-settings-input", function(event){

			var thisId = $(this).attr('id');
			var splitId = thisId.split('-');
			var thisIdNum = parseInt(splitId[5]);
			var totalInputs = $('.wpbooklist-buyback-settings-input').length;
			var thisVal = parseInt($(this).val());

			var iNum = 0;
			$('.wpbooklist-buyback-settings-input').each(function(index){
				if($(this).attr('id') == thisId){
					iNum = index;
				}
			})

			for (var i = iNum; i > 0; i--) {

				var curValId = $('.wpbooklist-buyback-settings-input')[i].id
				var nextNewVal = parseInt($('#'+curValId).val())-1;

				console.log('nextNewVal')
				console.log(nextNewVal)

				var nextId = $('.wpbooklist-buyback-settings-input')[i-1].id
				var nextCurrentVal = parseInt($('#'+nextId).val());

				if(nextCurrentVal >= thisVal){
					$('#'+nextId).val(nextNewVal);
				}
			}
		});
	}

	// Function that adds a row to the Sales Ranking settings page
	function wpbooklist_buyback_jre_add_sales_row(){
		$(document).on("click","#wpbooklist-buyback-settings-add-row-div", function(event){

			var nextNum = $('.wpbooklist-buyback-settings-input').length

			var secondLastId = $('.wpbooklist-buyback-settings-input')[nextNum-1].id;
			var nextFrom = parseInt($('#'+secondLastId).val())+1;
			var nextTo = nextFrom+1;

			var nextPercNum = $('.wpbooklist-buyback-settings-input-perc').length
			var LastPercId = $('.wpbooklist-buyback-settings-input-perc')[nextPercNum-1].id;
			var nextPerc = parseInt($('#'+LastPercId).val())-1;

			if(nextPerc <= 0){
				nextPerc = 1;
			}

			$('<div class="wpbooklist-buyback-settings-row-actual"><div class="wpbooklist-buyback-settings-row-actual-inner-row"><div class="wpbooklist-buyback-settings-row-actual-inner-row-top"><p class="wpbooklist-buyback-settings-row-actual-inner-row-top-p1">Amazon Sales Ranking</p><p class="wpbooklist-buyback-settings-row-actual-inner-row-top-p2">Percentage of Amazon Book Price to offer</p></div><div class="wpbooklist-buyback-settings-row-actual-inner-row-bottom"><p class="wpbooklist-buyback-settings-row-actual-inner-row-bottom-1">From: <input class="wpbooklist-buyback-settings-input" id=wpbooklist-buyback-settings-input-from-'+nextNum+' type="number" value="'+nextFrom+'" />To: <input class="wpbooklist-buyback-settings-input" id=wpbooklist-buyback-settings-input-to-'+nextNum+' type="number" value="'+nextTo+'" /></p><p style="position:relative; left:3px;" class="wpbooklist-buyback-settings-row-actual-inner-row-bottom-2">Percentage:<input style="margin-left:4px;"class="wpbooklist-buyback-settings-input-perc" id=wpbooklist-buyback-settings-input-perc-'+nextNum+' type="number" value="'+nextPerc+'" />%</p><p style="position:relative; left:8px;" class="wpbooklist-buyback-settings-row-actual-inner-row-bottom-3">Threshold:<input style="margin-left:4px;" class="wpbooklist-buyback-settings-input-perc" id=wpbooklist-buyback-settings-input-threshold-'+nextNum+' type="number" step="0.01" value="8.00" /></p></div></div></div>').insertBefore($(this).parent())

			$("#wpbooklist-buyback-settings-delete-row-div").removeAttr('disabled')
		});
	}


	// Function that deletes a row to the Sales Ranking settings page
	function wpbooklist_buyback_jre_delete_sales_row(){

		$(document).on("click","#wpbooklist-buyback-settings-delete-row-div", function(event){
			var idNumToRemove = $('.wpbooklist-buyback-settings-row-actual').length
			if(idNumToRemove > 1){
				var idToRemove = $('.wpbooklist-buyback-settings-row-actual')[idNumToRemove-1].remove()
			} else {
				$(this).attr('disabled','true')
			}
		});
	}

	// Function that deletes a row of the Sales Ranking settings page
	function wpbooklist_buyback_jre_save_sales_data(){

		$(document).on("click","#wpbooklist-buyback-settings-save-div button", function(event){
			var settingstring = '';
			$('#wpbooklist-spinner-buyback').animate({'opacity':'1'})
			$('.wpbooklist-buyback-settings-row-actual').each(function(){

				$(this).find('input').each(function(){
					settingstring += $(this).val()+'-';
				})
				settingstring += '0;';
			})

			settingstring = settingstring.substring(0, settingstring.length - 1);

			var data = {
				'action': 'wpbooklist_buyback_save_settings_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce11,
				'settingstring':settingstring,
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {

			    	document.location.reload(true);

			    }
			});

		});
	}

	// Function that saves changes to existing orders
	function wpbooklist_buyback_jre_save_order_changes(){
		$(document).on("click",".wpbooklist-buyback-settings-save-changes-row-div", function(event){
			var orderId = $(this).attr('data-orderid');
			var orderStatus = $('#wpbooklist-buyback-select-id-'+orderId).val();
			$('#wpbooklist-spinner-buyback').animate({'opacity':'1'})

			var data = {
				'action': 'wpbooklist_buyback_save_order_changes_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce12,
				'orderStatus':orderStatus,
				'orderId':orderId,
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {
			    	document.location.reload(true);
			    }
			});
		});
	}

	// Function that deletes an existing order
	function wpbooklist_buyback_jre_delete_existing_order(){
		$(document).on("click",".wpbooklist-buyback-settings-delete-order-row-div", function(event){
			var orderId = $(this).attr('data-orderid');
			$('#wpbooklist-spinner-buyback').animate({'opacity':'1'})

			var data = {
				'action': 'wpbooklist_buyback_delete_order_changes_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce13,
				'orderId':orderId,
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {
			    	document.location.reload(true);
			    	console.log(response)

			    }
			});
		});
	}
});