/**
 * JavaScript Admin Functions - wpbooklist-buyback-frontend.min.js
 *
 * @author   Jake Evans
 * @category JavaScript
 * @package  Includes/Assets/Js
 * @version  2.0.0
 */

console.log('This is the JavaScript Object that holds all PHP Variables for use in JavaScript')
console.log(wpbooklist_buyback_php_variables)


// All functions wrapped in jQuery(document).ready()...
jQuery(document).ready(function($) {
	"use strict";

	/* BEGINNING SECTION TO CALL ALL FUNCTIONS IN FILE... */
	wpbooklist_buyback_jre_find_book();

	wpbooklist_buyback_jre_open_colorbox();

	wpbooklist_buyback_jre_select_title();

	wpbooklist_buyback_jre_log_user_in();

	wpbooklist_buyback_jre_register_user();

	wpbooklist_buyback_jre_load_book_once_logged_in();

	wpbooklist_buyback_jre_remove_book_from_cart();

	wpbooklist_buyback_jre_display_paypal_email();

	wpbooklist_buyback_jre_finalize_user_sale();

	wpbooklist_buyback_jre_user_page_logout();


	/* ENDING SECTION TO CALL ALL FUNCTIONS IN FILE... */

	// Function that searches for provided ISBN number
	function wpbooklist_buyback_jre_find_book(){

		$("#wpbooklist-buyback-search-button").click(function(event){

			var author = $('#wpbooklist-buyback-author-input').val();
			var title = $('#wpbooklist-buyback-title-input').val();
			var isbn = $('#wpbooklist-buyback-isbn').val();
			var username = '';

			// Modify isbn to remove possible dashes 
			isbn = isbn.replace(/-/g, '');

			if (window.location.search.indexOf('buybackusername=') > -1) {
				var url = new URL(window.location.href);
				username = url.searchParams.get("buybackusername");
			}

			if(title == 'Search by Title'){
				title = '';
			}

			if(author == 'Search by Author'){
				author = '';
			}

			$('#wpbooklist-spinner-buyback').animate({'opacity':'1'})
			$('#wpbooklist-buyback-results-div').animate({'opacity':'0'})

			$('#wpbooklist-buyback-results-div').animate({opacity:0});

			var data = {
				'action': 'wpbooklist_buyback_search_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce3,
				'author':author,
				'title':title,
				'isbn':isbn,
				'username':username
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {

			    	console.log('this is the response')
			    	console.log(response)

			    	wpbooklist_buyback_jre_handle_search_results(response, 'initial');

			    	 // Clear ISBN input field
			    	 var isbn = $('#wpbooklist-buyback-isbn').val()
			    	 $('<input id="wpbooklist-buyback-isbn-hidden" type="hidden" style="display:none;" value="'+isbn+'"/>').insertAfter('#wpbooklist-buyback-isbn');
			    	 var isbn = $('#wpbooklist-buyback-isbn').val('')

			    }
			});
			event.preventDefault ? event.preventDefault() : event.returnValue = false;
		});
	}

	// Function that opens colorbox
	function wpbooklist_buyback_jre_open_colorbox(){

		$(document).on("click",".wpbooklist-buyback-colorbox", function(event){

			var title = $(this).parent().attr('data-title');
			var author = $(this).parent().attr('data-author');
			var category = $( "input[name='book-category']" ).val();
			var pages = $(this).parent().attr('data-pages');
			var pubYear = $(this).parent().attr('data-pubdate');
			var publisher = $(this).parent().attr('data-publisher');
			var description = $(this).parent().attr('data-description');
			var image = $(this).attr('src');
			var reviews = $(this).parent().attr('data-review');
			var isbn = $(this).parent().attr('data-isbn');
			var details = $(this).parent().attr('data-details');
			var similar = $(this).parent().attr('data-similar');

				var data = {
				'action': 'wpbooklist_buyback_colorbox_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce4,
				'title':title,
				'author':author,
				'category':category,
				'pages':pages,
				'pubYear':pubYear,
				'publisher':publisher,
				'description':description,
				'image':image,
				'reviews':reviews,
				'isbn':isbn,
				'details':details,
				'similar':similar
			};

			$.colorbox({
		        iframe:true,
		        title: "<?php echo $trans1; ?>", 
		        width: "50%", 
		        height: "80%", 
		        html: "&nbsp;", 
		        fastIframe:false,
		        onComplete:function(){
		          $('#cboxLoadingGraphic').show();
		          $('#cboxLoadingGraphic').css({'display':'block'})
		        }
		    });

	  		var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {

			    	$.colorbox({
						open: true,
						preloading: true,
						scrolling: true,
						width:'70%',
						height:'70%',
						html: response,
						onClosed:function(){
						  //Do something on close.
						},
						onComplete:function(){

							// Hide blank 'Similar Titles' images
							$('.wpbooklist-similar-image').load(function() {
								var image = new Image();
								image.src = $(this).attr("src");
								if(image.naturalHeight == '1'){
									$(this).parent().parent().css({'display':'none'})
								}
							});

							addthis.toolbox(
				              $(".addthis_sharing_toolbox").get()
				            );
				            addthis.toolbox(
				              $(".addthis_sharing_toolbox").get()
				            );
				            addthis.counter(
				              $(".addthis_counter").get()
				            );
						}
					});
			    }
			});
			event.preventDefault ? event.preventDefault() : event.returnValue = false;
	  	});
	}

	// Function that handles the selection of the 'Sell This Book' button
	function wpbooklist_buyback_jre_select_title(){
		$(document).on("click",".wpbooklist-buyback-select-title-button", function(event){

			var newIdRef = $("#wpbooklist-buyback-checkout-div");
			// Get Auto Height
			var autoHeight = newIdRef.css('height', 'auto').height(); 
			// Reset to Default Height
			newIdRef.height(0); 
			// Animate to Auto Height
			newIdRef.stop().animate({
            	height: autoHeight+150,
				opacity:1
            }, {
               duration: 1000,
               complete: function() { 
              	newIdRef.css({'height':'auto'});
               	

               } 
            });

		    var scrollTop = $('#wpbooklist-buyback-checkout-div').offset().top-50;
			if(scrollTop != 0){
			  $('html, body').animate({
			    scrollTop: scrollTop
			  }, 1000);
			  scrollTop = 0;
			}

		    var id = $(this).attr('data-buttonid');
		    var imgsrc = $(this).attr('data-bookimgsrc');
		    var bookisbn = $(this).attr('data-bookisbn');
		    var booktitle = $(this).attr('data-booktitle');
		    var bookvalue = $(this).attr('data-bookvalue');

		    $('#wpbooklist-buyback-login-button').attr('data-selectedbook', id);
		    $('#wpbooklist-buyback-register-button').attr('data-selectedbook', id);

		    // Build the string to add to and/or remove from the DB
		    //9780553448146;;;Artemis: A Novel;;;https://images-na.ssl-images-amazon.com/images/I/41mpiaisIIL.jpg;;;2.25----9780307887443;;;Ready Player One: A Novel;;;https://images-na.ssl-images-amazon.com/images/I/51NzrYog-7L.jpg;;;0.99
		    var dbString = bookisbn+';;;'+booktitle+';;;'+imgsrc+';;;'+bookvalue;

		    // Add a row in the Cart div, if we have book data
		    if(imgsrc != '' && booktitle != '' && bookisbn != ''){

			    var newrow = '<div class="wpbooklist-buyback-cart-div-row"><div class="wpbooklist-buyback-cart-img-div"><img class="wpbooklist-buyback-cart-img-actual" src="'+imgsrc+'"/></div><div style="margin-left:4px;" class="wpbooklist-buyback-cart-title-div"><p class="wpbooklist-buyback-cart-title-actual">'+booktitle+'</p><p class="wpbooklist-buyback-cart-title-isbn-actual">'+bookisbn+'</p></div><div style="margin-left:3px;" class="wpbooklist-buyback-cart-value-div"><p class="wpbooklist-buyback-cart-value-actual">$'+bookvalue+'</p><div class="wpbooklist-buyback-cart-value-remove-div" data-dbstring="'+dbString+'"><img class="wpbooklist-buyback-cart-value-remove-img-actual" src="'+wpbooklist_buyback_php_variables.wpbooklistbuybackrootimgiconsurl+'cancel-button.svg" /><p style="margin-left:3px;" class="wpbooklist-buyback-cart-value-remove-text-actual">Remove from Cart</p></div></div></div>';

				$(newrow).insertBefore($('.wpbooklist-buyback-cart-summary-row'));

				// Update cart total values
				$('#wpbooklist-buyback-cart-summary-span-value-calc').text((parseFloat($('#wpbooklist-buyback-cart-summary-span-value-calc').text())+parseFloat(bookvalue)).toFixed(2))
				$('#wpbooklist-buyback-cart-summary-span-total-calc').text(parseInt($('#wpbooklist-buyback-cart-summary-span-total-calc').text())+1);

				// Now make Ajax call to server to add new book to the Cart field in DB
				var data = {
					'action': 'wpbooklist_buyback_add_to_cart_action',
					'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce8,
					'title':booktitle,
					'isbn':bookisbn,
					'image':imgsrc,
					'value':bookvalue,

				};

				var request = $.ajax({
				    url: ajaxurl,
				    type: "POST",
				    data:data,
				    timeout: 0,
				    success: function(response) {

				    }
				});
			}

			event.preventDefault ? event.preventDefault() : event.returnValue = false;
		});
	}

	// Function that handles the logging in of the user
	function wpbooklist_buyback_jre_log_user_in(){
		$(document).on("click","#wpbooklist-buyback-login-button", function(event){

			$('#wpbooklist-buyback-login-reg-button-error-p').text('')
			var email = $('#wpbooklist-buyback-login-reg-contact-field-username').val();
			var password = $('#wpbooklist-buyback-login-reg-contact-field-password').val();
			var isbn = $('#wpbooklist-buyback-isbn-hidden').val();
			var search = $('#wpbooklist-buyback-title-input').val();
			var book = $(this).attr('data-selectedbook');
			var proceed = false;

			// Checks for no input
			if(email == ''){
				$('#wpbooklist-buyback-login-reg-button-error-p').text('Enter a Username/E-Mail Address!');
				return;
			}

			// Checks for no input
			if(password == ''){
				$('#wpbooklist-buyback-login-reg-button-error-p').text('Enter a Password!')
				return;
			}

			proceed = true;

			if(proceed){

				$('#wpbooklist-spinner-buyback-login').animate({'opacity':'1'})

				var data = {
					'action': 'wpbooklist_buyback_login_action',
					'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce5,
					'email':email,
					'password':password
				};

				var request = $.ajax({
				    url: ajaxurl,
				    type: "POST",
				    data:data,
				    timeout: 0,
				    success: function(response) {


				    	if(response == '--Username Found----Password Matches--'){
				    		var newUrl = window.location.href+'?buybackusername='+email+'&isbn='+isbn+'&book='+book;
				    		window.location.href = newUrl;
				    	}

				    	if(response == '--Username Found----Password Does Not Match--'){
				    		$('#wpbooklist-buyback-login-reg-button-error-p').text('Whoops! Looks like you entered the wrong password!');
				    		$('#wpbooklist-spinner-buyback-login').animate({'opacity':'0'})
				    	}

				    	if(response.indexOf('Username not found!--') > -1){
				    		$('#wpbooklist-buyback-login-reg-button-error-p').text('Whoops! Looks like we can\'t find that Username!');
				    		$('#wpbooklist-spinner-buyback-login').animate({'opacity':'0'})
				    	}
				    }
				});
			}

			event.preventDefault ? event.preventDefault() : event.returnValue = false;
		});
	}


	// Function that handles the registering of the user
	function wpbooklist_buyback_jre_register_user(){

		$(document).on("click","#wpbooklist-buyback-register-button", function(event){

			$('#wpbooklist-buyback-register-button-error-p').text('')
			var email = $('#wpbooklist-buyback-login-reg-contact-field-email').val();
			var password = $('#wpbooklist-buyback-login-reg-contact-field-register-password').val();
			var password2 = $('#wpbooklist-buyback-login-reg-contact-field-register-reenterpassword').val();
			var firstname = $('#wpbooklist-buyback-login-reg-contact-field-firstname').val();
			var lastname = $('#wpbooklist-buyback-login-reg-contact-field-lastname').val();
			var streetaddress = $('#wpbooklist-buyback-login-reg-contact-field-streetaddress').val();
			var city = $('#wpbooklist-buyback-login-reg-contact-field-city').val();
			var state = $('#wpbooklist-buyback-login-reg-contact-field-state').val();
			var zip = $('#wpbooklist-buyback-login-reg-contact-field-zip').val();


			var isbn = $('#wpbooklist-buyback-isbn-hidden').val();
			var search = $('#wpbooklist-buyback-title-input').val();
			var book = $(this).attr('data-selectedbook');
			var buttonClass = $(this).attr('class');
			var proceed = false;

			// Checks for no input
			if(firstname == ''){
				$('#wpbooklist-buyback-register-button-error-p').text('Enter your First Name!')
				return;
			}

			// Checks for no input
			if(lastname == ''){
				$('#wpbooklist-buyback-register-button-error-p').text('Enter your Last Name!')
				return;
			}

			// Checks for no input
			if(streetaddress == ''){
				$('#wpbooklist-buyback-register-button-error-p').text('Enter your Street Address!')
				return;
			}

			// Checks for no input
			if(city == ''){
				$('#wpbooklist-buyback-register-button-error-p').text('Enter a City!')
				return;
			}

			// Checks for no input
			if(state == 'Select a State...'){
				$('#wpbooklist-buyback-register-button-error-p').text('Select a State!')
				return;
			}

			// Checks for no input
			if(zip == ''){
				$('#wpbooklist-buyback-register-button-error-p').text('Enter a Zip Code!')
				return;
			}

			// Checks for no input
			if(password == ''){
				$('#wpbooklist-buyback-register-button-error-p').text('Enter a Password!')
				return;
			}

			// Checks for no input
			if(password2 == ''){
				$('#wpbooklist-buyback-register-button-error-p').text('Re-Enter your Password!')
				return;
			}

			if(password !== password2){
				$('#wpbooklist-buyback-register-button-error-p').text('Your passwords don\'t match!')
				return;
			}

			if(email == ''){
				$('#wpbooklist-buyback-register-button-error-p').text('Enter an E-Mail Address!');
				return;
			}

			proceed = true;

			if(proceed){

				$('#wpbooklist-spinner-buyback-register').animate({'opacity':'1'})

				var data = {
					'action': 'wpbooklist_buyback_register_userdata_action',
					'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce7,
					'username':email,
					'password':password,
					'email':email,
					'state':state,
					'city':city,
					'streetaddress':streetaddress,
					'firstname':firstname,
					'lastname':lastname,
					'zip':zip
				};

				var request = $.ajax({
				    url: ajaxurl,
				    type: "POST",
				    data:data,
				    timeout: 0,
				    success: function(response) {

				    	$('#wpbooklist-spinner-buyback-register').animate({'opacity':'0'})

				    	if(response == 'Success!'){
				    		$('#wpbooklist-buyback-register-button-error-p').text('Success!');

				    		// Redirect to whatever page the admin has specified is the 'Book Search' page, with or without params, depending on whether user is submitting their login/registeration info from the 'Book Search' page alreay, or if they're on the separate 'Login/Registeration' page
				    		if(buttonClass != 'wpbooklist-buyback-login-button-user-page'){
				    			var newUrl = 'https://booksabillions.net/?buybackusername='+email+'&isbn='+isbn+'&book='+book;
				    		} else {
				    			var newUrl = 'https://booksabillions.net/';
				    		}

				    		window.location.href = newUrl;

				    	} else {
				    		$('#wpbooklist-buyback-register-button-error-p').text(response);
				    	}
				    }
				});
			}
			event.preventDefault ? event.preventDefault() : event.returnValue = false;
		});
	}




	// Function that removes a book from user's cart
	function wpbooklist_buyback_jre_remove_book_from_cart(){
		$(document).on("click",".wpbooklist-buyback-cart-value-remove-div", function(event){
			$(this).parent().parent().remove()

			// Adjust cart totals/values
			var currentNum = $('#wpbooklist-buyback-cart-summary-span-total-calc').text();
			$('#wpbooklist-buyback-cart-summary-span-total-calc').text(parseInt(currentNum)-1)

			var currentVal = $('#wpbooklist-buyback-cart-summary-span-value-calc').text();
			var bookVal = $(this).prev().text()
			bookVal = bookVal.replace('$','');
			$('#wpbooklist-buyback-cart-summary-span-value-calc').text((parseFloat($('#wpbooklist-buyback-cart-summary-span-value-calc').text())-parseFloat(bookVal)).toFixed(2))


			// Now remove from db
			var dbString = $(this).attr('data-dbstring');
			var data = {
				'action': 'wpbooklist_buyback_add_to_cart_remove_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce9,
				'dbString':dbString
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {

			    }
			});

		});
	}

	// Function that displays the PayPal E-Mail fields if selected from drop-down
	function wpbooklist_buyback_jre_display_paypal_email(){
		$(document).on("change","#wpbooklist-buyback-checkout-contact-field-payment", function(event){
			if($(this).val() == 'PayPal'){
				$('.wpbooklist-buyback-checkout-row-paypal-email').animate({'height':'88px', 'opacity':'1'})
			}
		});
	}

	// Function that finalizes user's sale
	function wpbooklist_buyback_jre_finalize_user_sale(){
		$(document).on("click","#wpbooklist-buyback-finalize-sale-button", function(event){

			// Get all values again to make sure no contact info changed
			$('#wpbooklist-buyback-finalize-sale-button-error-p').text('')
			var email = $('#wpbooklist-buyback-checkout-contact-field-email').val();
			var firstname = $('#wpbooklist-buyback-checkout-contact-field-firstname').val();
			var lastname = $('#wpbooklist-buyback-checkout-contact-field-lastname').val();
			var streetaddress = $('#wpbooklist-buyback-checkout-contact-field-streetaddress').val();
			var city = $('#wpbooklist-buyback-checkout-contact-field-city').val();
			var state = $('#wpbooklist-buyback-checkout-contact-field-state').val();
			var zip = $('#wpbooklist-buyback-checkout-contact-field-zipcode').val();
			var phone = $('#wpbooklist-buyback-checkout-contact-field-phone').val();
			var paymentMethod = $('#wpbooklist-buyback-checkout-contact-field-payment').val();
			var paypal1 = '';
			var paypal2 = '';
			var books = '';

			// Build Books string from cart
			var books = '';
			$('.wpbooklist-buyback-cart-div-row').each(function(){
				//9780553448146;;;Artemis: A Novel;;;https://images-na.ssl-images-amazon.com/images/I/41mpiaisIIL.jpg;;;2.49----9781492650959;;;The Radium Girls: The Dark Story of America\&#39;s Shining Women;;;https://images-na.ssl-images-amazon.com/images/I/51t86%2BXZO3L.jpg;;;3.36----9781492650959;;;The Radium Girls: The Dark Story of America\&#39;s Shining Women;;;https://images-na.ssl-images-amazon.com/images/I/51t86%2BXZO3L.jpg;;;3.36

				var imgsrc = $(this).find('.wpbooklist-buyback-cart-img-actual').attr('src');
				var title = $(this).find('.wpbooklist-buyback-cart-title-actual').text();
				var isbn = $(this).find('.wpbooklist-buyback-cart-title-isbn-actual').text();
				var value = $(this).find('.wpbooklist-buyback-cart-value-actual').text().replace('$','');

				books = books+isbn+';;;'+title+';;;'+imgsrc+';;;'+value+'----';
			});


			// Checks for no input
			if(firstname == ''){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter your First Name!')
				return;
			}

			// Checks for no input
			if(lastname == ''){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter your Last Name!')
				return;
			}

			if(email == ''){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter an E-Mail Address!');
				return;
			}

			// Checks for no input
			if(streetaddress == ''){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter your Street Address!')
				return;
			}

			// Checks for no input
			if(city == ''){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter a City!')
				return;
			}

			// Checks for no input
			if(state == 'Select a State...' || state == null){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Select a State!')
				return;
			}

			// Checks for no input
			if(zip == ''){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter a Zip Code!')
				return;
			}

			// Checks for no input
			if(phone == ''){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter a Phone Number!')
				return;
			}

			// Checks for no input
			if(paymentMethod == 'Select a Payment Method...'  || paymentMethod == null){
				$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Choose a Payment Method!')
				return;
			}


			if($('#wpbooklist-buyback-checkout-contact-field-payment').val() == 'PayPal'){
				paypal1 = $('#wpbooklist-buyback-checkout-contact-field-paypalemail-1').val();
				paypal2 = $('#wpbooklist-buyback-checkout-contact-field-paypalemail-2').val();

				if(paypal1 == ''){
					$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Enter a PayPal E-Mail Address!');
					return;
				}

				if(paypal2 == ''){
					$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Verify your PayPal E-Mail Address!');
					return;
				}

				if(paypal1 !== paypal2){
					$('#wpbooklist-buyback-finalize-sale-button-error-p').text('Looks like your PayPal E-Mail Addresses don\'t match!');
					return;
				}
			}

			$('#wpbooklist-spinner-buyback-finalize-sale').animate({'opacity':'1'})

			var data = {
				'action': 'wpbooklist_buyback_finalize_sale_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce10,
				'firstname':firstname,
				'lastname':lastname,
				'books':books,
				'streetaddress':streetaddress,
				'phone':phone,
				'email':email,
				'paypalemail':paypal2,
				'paymentmethod':paymentMethod,
				'city':city,
				'state':state,
				'zip':zip
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {
			    
			    	if(response == 'Success!'){

			    		response = "<p>You've successfully placed your order! You should recieve an E-Mail with further instructions shortly.</p><p>Thanks for choosing BooksaBillion!</p>"
			    	}
			    	$('#wpbooklist-spinner-buyback-finalize-sale').animate({'opacity':'0'})

			    	$('#wpbooklist-buyback-finalize-sale-button-error').html(response);
			    }
			});
		});
	}










































	// Function that handles the returning of book results
	function wpbooklist_buyback_jre_handle_search_results(results, phase){

		var origResponse = results;
		var results = results.split('--sep--seperator--sep--');

		// Add the returned form to the DOM
		$('#wpbooklist-buyback-checkout-div').html(results[2]);

		var pricingScheme = JSON.parse(results[1]);
    	results = JSON.parse(results[0]);
    	
    	var html = '<div id="wpbooklist-buyback-results-container"><div id="wpbooklist-buyback-add-books-div"><div id="wpbooklist-buyback-library-select"></div></div></div>';


    	if(results == undefined || results.Items == undefined || results.Items.Item == undefined){
    		$('#wpbooklist-buyback-results-div').html('<p>Whoops! We couldn\'t find any results for your Book Search! Be sure to check the Title and/or Author you provided and try again!</p>' );
	    	$('#wpbooklist-buyback-results-div').animate({'opacity':'1'});
	    	$('#wpbooklist-spinner-buyback').animate({'opacity':'0'});
    	} else {

    		var resultsLength = results.Items.Item.length;
	    	if(resultsLength == undefined){
	    		resultsLength = 1;
	    	}

	    	if(phase == 'initial'){
	    		loopControl = resultsLength-1;
	    	}

	    	if(phase == 'titlesearch'){
	    		var loopControl = 0
	    	}

	    	//for (var i = loopControl; i < resultsLength; i++) {
	    		var image = '';
	    		var author = '';
	    		var category = '';
	    		var pages = '';
	    		var publisher = '';
	    		var pubdate = '';
	    		var title = '';
	    		var description = '';
	    		var isbn = '';
	    		var review = '';
	    		var similar = '';
	    		var image = '';
	    		var isbn = '';
	    		var details = '';
	    		var similarproductsstring = '';
	    		var itemRank = 0;
	    		var lowestUsedUnformatted = '';
	    		var lowestUsedFormatted = '';

	    		if(results.Items.Item[0] != undefined){

	    			console.log('The Array below is all returned data from Amazon:')
	    			console.log(results.Items.Item[0]);


	    			// Get rank and pricing data
	    			if(results.Items.Item[0].OfferSummary != undefined && results.Items.Item[0].OfferSummary.LowestUsedPrice != undefined){
		    			lowestUsedUnformatted = results.Items.Item[0].OfferSummary.LowestUsedPrice.Amount;
		    			lowestUsedFormatted = results.Items.Item[0].OfferSummary.LowestUsedPrice.FormattedPrice;
		    			itemRank = results.Items.Item[0].SalesRank;
	    			}

	  

	    		console.log('lowestUsedUnformatted')
	    		console.log(lowestUsedUnformatted)


	    		console.log('lowestUsedFormatted')
	    		console.log(lowestUsedFormatted)


	    			// Get other data
	    			if(results.Items.Item[0].SimilarProducts != undefined){
		    			if(results.Items.Item[0].SimilarProducts.SimilarProduct != undefined){
		    				for (var r = 0; r < results.Items.Item[0].SimilarProducts.SimilarProduct.length; r++) {
		    					similarproductsstring = similarproductsstring+';bsp;'+results.Items.Item[0].SimilarProducts.SimilarProduct[r].ASIN+'---'+results.Items.Item[0].SimilarProducts.SimilarProduct[r].Title;
		    				};
		    			}
	    			}


	    			if(results.Items.Item[0].ASIN != undefined){
	    				isbn = results.Items.Item[0].ASIN;
	    			}

	    			if(results.Items.Item[0].CustomerReviews != undefined){
	    				if(results.Items.Item[0].CustomerReviews.IFrameURL != undefined){
	    					review = results.Items.Item[0].CustomerReviews.IFrameURL;
	    				}
	    			}

	    			if(results.Items.Item[0].DetailPageURL != undefined){
	    				details = results.Items.Item[0].DetailPageURL;
	    			}

	    			if(results.Items.Item[0].ItemAttributes != undefined){

		    			if(results.Items.Item[0].ItemAttributes.Author != undefined){
		    				author = results.Items.Item[0].ItemAttributes.Author;
		    			}

		    			if(results.Items.Item[0].ItemAttributes.EAN != undefined){
		    				isbn = results.Items.Item[0].ItemAttributes.EAN;
		    			}

		    			if(results.Items.Item[0].ItemAttributes.NumberOfPages != undefined){
		    				pages = results.Items.Item[0].ItemAttributes.NumberOfPages;
		    			}

		    			if(results.Items.Item[0].ItemAttributes.Publisher != undefined){
		    				publisher = results.Items.Item[0].ItemAttributes.Publisher;
		    			}

		    			if(results.Items.Item[0].ItemAttributes.PublicationDate != undefined){
		    				pubdate = results.Items.Item[0].ItemAttributes.PublicationDate;
		    			}

		    			if(results.Items.Item[0].ItemAttributes.Title != undefined){
		    				title = results.Items.Item[0].ItemAttributes.Title;
		    			}
	    			}

	    			if(results.Items.Item[0].LargeImage != undefined && results.Items.Item[0].LargeImage.URL != undefined){
	    				image = results.Items.Item[0].LargeImage.URL;
	    			} else {
	    				image = '';
	    			}

	    			if(results.Items.Item[0].EditorialReviews != undefined && results.Items.Item[0].EditorialReviews.EditorialReview != undefined && results.Items.Item[0].EditorialReviews.EditorialReview.Content){
	    				description = results.Items.Item[0].EditorialReviews.EditorialReview.Content;
	    				description = description.replace(/"/g,'\'');
	    				description = description.replace(/“/g,'\'');
	    			}

	    			if(description == ''){
	    				if(results.Items.Item[0].EditorialReviews != undefined && results.Items.Item[0].EditorialReviews.EditorialReview[0] != undefined){
		    				description = results.Items.Item[0].EditorialReviews.EditorialReview[0].Content;
		    				description = description.replace(/"/g,'\'');
		    				description = description.replace(/“/g,'\'');
	    				}
	    			}
	    		} else {

	    			// Get rank and pricing data
	    			if(results.Items.Item.OfferSummary != undefined && results.Items.Item.OfferSummary.LowestUsedPrice != undefined){
		    			lowestUsedUnformatted = results.Items.Item.OfferSummary.LowestUsedPrice.Amount;
		    			lowestUsedFormatted = results.Items.Item.OfferSummary.LowestUsedPrice.FormattedPrice;
		    			itemRank = results.Items.Item.SalesRank;
	    			}

	    			if(results.Items.Item.SimilarProducts != undefined){
		    			if(results.Items.Item.SimilarProducts.SimilarProduct != undefined){
		    				for (var r = 0; r < results.Items.Item.SimilarProducts.SimilarProduct.length; r++) {
		    					similarproductsstring = similarproductsstring+';bsp;'+results.Items.Item.SimilarProducts.SimilarProduct[r].ASIN+'---'+results.Items.Item.SimilarProducts.SimilarProduct[r].Title;
		    				};
		    			}
	    			}


	    			if(results.Items.Item.ASIN != undefined){
	    				isbn = results.Items.Item.ASIN;
	    			}

	    			if(results.Items.Item.CustomerReviews != undefined){
	    				if(results.Items.Item.CustomerReviews.IFrameURL != undefined){
	    					review = results.Items.Item.CustomerReviews.IFrameURL;
	    				}
	    			}

	    			if(results.Items.Item.DetailPageURL != undefined){
	    				details = results.Items.Item.DetailPageURL;
	    			}

	    			if(results.Items.Item.ItemAttributes != undefined){

		    			if(results.Items.Item.ItemAttributes.Author != undefined){
		    				author = results.Items.Item.ItemAttributes.Author;
		    			}

		    			if(results.Items.Item.ItemAttributes.EAN != undefined){
		    				isbn = results.Items.Item.ItemAttributes.EAN;
		    			}

		    			if(results.Items.Item.ItemAttributes.NumberOfPages != undefined){
		    				pages = results.Items.Item.ItemAttributes.NumberOfPages;
		    			}

		    			if(results.Items.Item.ItemAttributes.Publisher != undefined){
		    				publisher = results.Items.Item.ItemAttributes.Publisher;
		    			}

		    			if(results.Items.Item.ItemAttributes.PublicationDate != undefined){
		    				pubdate = results.Items.Item.ItemAttributes.PublicationDate;
		    			}

		    			if(results.Items.Item.ItemAttributes.Title != undefined){
		    				title = results.Items.Item.ItemAttributes.Title;
		    			}
	    			}

	    			if(results.Items.Item.LargeImage != undefined && results.Items.Item.LargeImage.URL != undefined){
	    				image = results.Items.Item.LargeImage.URL;
	    			} else {
	    				image = '';
	    			}

	    			if(results.Items.Item.EditorialReviews != undefined && results.Items.Item.EditorialReviews.EditorialReview != undefined && results.Items.Item.EditorialReviews.EditorialReview.Content){
	    				description = results.Items.Item.EditorialReviews.EditorialReview.Content;
	    				description = description.replace(/"/g,'\'');
	    				description = description.replace(/“/g,'\'');
	    			}

	    			if(description == ''){
	    				if(results.Items.Item.EditorialReviews != undefined && results.Items.Item.EditorialReviews.EditorialReview[0] != undefined){
		    				description = results.Items.Item.EditorialReviews.EditorialReview[0].Content;
		    				description = description.replace(/"/g,'\'');
		    				description = description.replace(/“/g,'\'');
	    				}
	    			}

	    			console.log('The Array below is all returned data from Amazon:')
	    			console.log(results.Items.Item);

	    			console.log('lowestUsedUnformatted')
		    		console.log(lowestUsedUnformatted)


		    		console.log('lowestUsedFormatted')
		    		console.log(lowestUsedFormatted)
	    		}

	    		// Now build offer price with the saved pricing scheme data
	    		//0-20000-30-8;20001-30000-20-6
	    		var tempPricingScheme = pricingScheme[0].rankcalcs.split(';');
	    		var loopControl2 = tempPricingScheme.length;
	    		var finalPrice = 0.00;
	    		var finalPriceWithoutSym = 0.00;
	    		var threshold = 0.00;
	    		
	    		for (var r = 0; r < loopControl2; r++) {

	    			if(finalPrice == 0.00){

		    			var tempPricingScheme2 = tempPricingScheme[r].split('-');

		    			if(itemRank >= parseInt(tempPricingScheme2[0]) && itemRank <= parseInt(tempPricingScheme2[1])){
		    				
		    				var monetarySymbol = lowestUsedFormatted.substring(0,1);
		    				var amountForCalc = lowestUsedFormatted.substring(1);

		    				finalPrice = (amountForCalc*(tempPricingScheme2[2]*0.01)).toFixed(2);
		    				finalPriceWithoutSym = finalPrice;
		    				finalPrice = monetarySymbol+finalPrice;
		    				threshold = tempPricingScheme2[3];

		    				console.log( 'This book\'s Item Rank is: ' +  itemRank);

		    				console.log('Book falls within the ' + tempPricingScheme2[0] + ' and ' + tempPricingScheme2[1] + ' sales ranking range.');

		    				console.log('Active Offer Percentage:')
	    					console.log(tempPricingScheme2[2] + '%')

		    				console.log('Active Price Threshold:')
	    					console.log('$' + threshold)
		    			}
	    			}
	    		};

	    		var disabledButton="";
	    		var buttonOpacity = 1;
	    		var inlinePriceStyle = '';

	    		console.log('finalPrice')
	    		console.log(finalPrice)

	    		console.log('finalPriceWithoutSym')
	    		console.log(finalPriceWithoutSym)

	    		if(finalPrice == 0){
	    			console.log('Final Calculated price for this title is 0, so we can\'t buy it.')
	    		}

	    		if(finalPrice == 0.00){
	    			console.log('Final Calculated price for this title is 0.00, so we can\'t buy it.')
	    		}

	    		if(  parseFloat(finalPriceWithoutSym) < parseInt(threshold)   ){
	    			console.log('Final Calculated price for this title is less than the specificed price threshold, so we can\'t buy it.')
	    		}

	    		lowestUsedFormatted = lowestUsedFormatted.split('$')[1];

	    		console.log('fdsfdsafdfds')
	    		console.log(lowestUsedFormatted)


	    		if(finalPrice == 0 || finalPrice == 0.00 || parseFloat(lowestUsedFormatted) < parseInt(threshold)  ){
	    			finalPrice = "Sorry, we're unable to purchase this title!";
	    			inlinePriceStyle = 'bottom:0; font-size:18px;';
	    			disabledButton = 'disabled';
	    			buttonOpacity = 0;
	    		}
	    		


	    		if(image == null || image == undefined || image == ''){
	    			image = wpbooklist_buyback_php_variables.wpbooklistbuybackrootimgiconsurl
+'image_unavaliable.png';
	    		}


	    		html = html+'<div class="wpbooklist-buyback-indiv-holder"><div data-priceformatted="'+lowestUsedFormatted+'" data-unformatted="'+lowestUsedUnformatted+'" data-rank="'+itemRank+'" data-similar="'+similarproductsstring+'" data-details="'+details+'" data-isbn="'+isbn+'" data-title="'+title+'" data-author="'+author+'" data-category="'+category+'" data-pages="'+pages+'" data-publisher="'+publisher+'" data-pubdate="'+pubdate+'" data-description="'+description+'" data-isbn="'+isbn+'" data-review="'+review+'" data-similar="'+similar+'"   class="wpbooklist-buyback-results-indiv"><img class="wpbooklist-buyback-colorbox" src="'+image+'" /><div id="wpbooklist_saved_title_and_select_div"><p class="wpbooklist_saved_title_link" id="wpbooklist_saved_title_link">'+title+'</p><div style="'+inlinePriceStyle+'" class="wpbooklist-buyback-quote-div"><span class="wpbooklist-buyback-quote-label">Quote:</span><span class="wpbooklist-buyback-quote-actual">'+finalPrice+'</span></div><div class="wpbooklist-buyback-checkbox-div"><button style="opacity:'+buttonOpacity+';" '+disabledButton+' id="wpbooklist-buyback-select-title-button-id-'+0+'" data-triggered="false" data-bookimgsrc="'+image+'" data-bookisbn="'+isbn+'" data-bookvalue="'+finalPriceWithoutSym+'" data-booktitle="'+title+'" data-buttonid="'+0+'" class="wpbooklist-buyback-select-title-button">Sell This Book</button></div></div></div></div>';
	    	//};
			
			if(phase == 'initial'){
	    		html = html+'<div id="wpbooklist-buyback-notbook-div"><p>Not the Right Book? Search by title here:</p><input placeholder="Search by Title" id="wpbooklist-buyback-title-input" type="text"/><button id="wpbooklist-buyback-search-title-button">Search by Title</button></div></div>';
	    	 } else {
	    	 	html = html+'';
	    	 }

	    	 // Set the state drop-down
	    	 origResponse = origResponse.split('--sep--seperator--sep--');
	    	 $('#wpbooklist-buyback-checkout-contact-field-state').val(origResponse[4]);

	    	$('#wpbooklist-buyback-results-div').html(html);
	    	$('#wpbooklist-buyback-library-select').html(results[1]);
	    	$('#wpbooklist-buyback-results-div').animate({'opacity':'1'})
	    	$('#wpbooklist-spinner-buyback').animate({'opacity':'0'})
    	}		    	
    }

	// Function that handles the display after the user selects a book and then logs in 
	function wpbooklist_buyback_jre_load_book_once_logged_in(){
	    jQuery(window).load(function () {

			var isbnbox = $('#wpbooklist-buyback-isbn');
			var hiddenisbnbox = $('#wpbooklist-buyback-isbn-hidden');


			var isbnsubmit = $('#wpbooklist-buyback-search-button');

			if ((window.location.search.indexOf('buybackusername=') > -1) && isbnbox.length > 0) {

				var url = new URL(window.location.href);
				var email = url.searchParams.get("buybackusername");

				var data = {
					'action': 'wpbooklist_buyback_populate_userdata_action',
					'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce6,
					'email':email
				};

				var request = $.ajax({
				    url: ajaxurl,
				    type: "POST",
				    data:data,
				    timeout: 0,
				    success: function(response) {

				    	response = JSON.parse(response);

				    	var checkExistFields = setInterval(function() {
						   if ('#wpbooklist-buyback-checkout-contact-field-firstname'.length) {
						      	$('#wpbooklist-buyback-checkout-contact-field-firstname').val(response[0].firstname);
				    			$('#wpbooklist-buyback-checkout-contact-field-lastname').val(response[0].lastname);
				    			$('#wpbooklist-buyback-checkout-contact-field-streetaddress').val(response[0].streetaddress);
				    			$('#wpbooklist-buyback-checkout-contact-field-city').val(response[0].city);
				    			//$('#wpbooklist-buyback-checkout-contact-field-state').val(response[0].state);
				    			$('#wpbooklist-buyback-checkout-contact-field-zip').val(response[0].zipcode);
						      	
						      	if($('#wpbooklist-buyback-checkout-contact-field-firstname').val() == response[0].firstname){
						      		clearInterval(checkExistFields);
						      	}
						   }
						}, 100); // check every 100ms				    	
				    }
				});

				var url = new URL(window.location.href);
				var username = url.searchParams.get("buybackusername");
				var isbn = url.searchParams.get("isbn");
				var searchterm = url.searchParams.get("search");
				var book = url.searchParams.get("book");

				isbnbox.val(isbn);
				hiddenisbnbox.val(isbn);
				isbnsubmit.trigger('click');
				

				var checkExist = setInterval(function() {
					console.log('checkExist')
				   if (  $('#wpbooklist-buyback-select-title-button-id-'+book).length > 0){
				   		clearInterval(checkExist);
				   		$('#wpbooklist-buyback-select-title-button-id-'+book).trigger('click');
				   		console.log('Greater than zero!')

				   	
				   }
				}, 100); // check every 100ms


			}
		});
	}

	function wpbooklist_buyback_jre_user_page_logout(){

		$(document).on("click","#wpbooklist-buyback-userpage-welcome-div-logout-button", function(event){

			var data = {
				'action': 'wpbooklist_buyback_logout_action',
				'security': wpbooklist_buyback_php_variables.wpbooklistbuybacknonce14,
			};

			var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {
			    	document.location.reload(true);
			    	
			    }
			});

			event.preventDefault ? event.preventDefault() : event.returnValue = false;


		});


	}








});